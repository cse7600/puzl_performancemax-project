<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>키워드 검색량 조회</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, sans-serif; background: #f2f2f2; padding: 32px 20px; }

    .container { max-width: 1300px; margin: 0 auto; }
    h1 { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #111; }

    /* 입력 폼 */
    .form-box {
      background: white; border-radius: 8px; padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,.08); margin-bottom: 20px;
    }
    .form-row { display: flex; gap: 12px; align-items: flex-start; }
    textarea {
      flex: 1; height: 80px; padding: 10px 12px; font-size: 14px;
      border: 1px solid #ddd; border-radius: 6px; resize: vertical;
      font-family: inherit; line-height: 1.5;
    }
    textarea:focus { outline: none; border-color: #4285F4; }
    .form-side { display: flex; flex-direction: column; gap: 8px; min-width: 120px; }
    .btn-search {
      padding: 0 20px; height: 80px; font-size: 15px; font-weight: 700;
      border: none; border-radius: 6px; cursor: pointer;
      background: #4285F4; color: white; white-space: nowrap;
    }
    .btn-search:hover { background: #2b6fd6; }
    .btn-search:disabled { background: #aaa; cursor: not-allowed; }
    .hint { font-size: 11px; color: #999; line-height: 1.5; }

    /* 로딩 */
    .loading {
      display: none; text-align: center; padding: 40px;
      font-size: 14px; color: #666;
    }
    .spinner {
      display: inline-block; width: 20px; height: 20px;
      border: 3px solid #eee; border-top-color: #4285F4;
      border-radius: 50%; animation: spin .8s linear infinite;
      margin-right: 8px; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* 오류 */
    .error {
      background: #fff0f0; border-left: 3px solid #e74c3c;
      padding: 12px 16px; border-radius: 4px; color: #c0392b;
      font-size: 13px; margin-bottom: 16px;
    }

    /* 결과 영역 */
    .result-box {
      background: white; border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,.08); overflow: hidden;
    }
    .result-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 18px; border-bottom: 1px solid #eee;
    }
    .result-meta { font-size: 13px; color: #555; }
    .result-meta b { color: #111; font-size: 15px; }
    .source-badges { display: flex; gap: 6px; margin-left: 10px; display: inline-flex; }
    .badge {
      font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px;
      vertical-align: middle;
    }
    .badge-naver { background: #edfaf3; color: #03C75A; border: 1px solid #b3f0ce; }
    .badge-google { background: #e8f0fe; color: #4285F4; border: 1px solid #c5d8fc; }

    .btn-dl {
      padding: 7px 16px; font-size: 13px; font-weight: 600;
      border: 1px solid #ccc; border-radius: 5px; cursor: pointer;
      background: white; color: #333;
    }
    .btn-dl:hover { background: #f5f5f5; }

    /* 테이블 */
    .table-wrap { overflow-x: auto; }
    .result-table { border-collapse: collapse; width: 100%; font-size: 13px; min-width: 800px; }

    .result-table thead th {
      padding: 10px 14px; text-align: right; white-space: nowrap;
      background: #f7f7f7; color: #444; font-weight: 600;
      border-bottom: 2px solid #e0e0e0; font-size: 12px;
    }
    .result-table thead th:first-child { text-align: left; }
    .result-table thead th.col-naver { color: #02a84c; }
    .result-table thead th.col-google { color: #4285F4; }

    .result-table tbody td {
      padding: 9px 14px; border-bottom: 1px solid #f0f0f0;
      text-align: right; color: #222;
    }
    .result-table tbody td:first-child { text-align: left; font-weight: 500; }
    .result-table tbody tr:hover td { background: #fafafa; }

    /* 구분선: 네이버 컬럼 끝 */
    .result-table .sep-right { border-right: 2px solid #e0e0e0; }

    /* 구글 검색량 0이면 흐리게 */
    .dim { color: #bbb; }

    /* 경쟁도 뱃지 */
    .comp { font-size: 11px; font-weight: 600; padding: 2px 7px; border-radius: 10px; }
    .comp-low    { background: #edfaf3; color: #03C75A; }
    .comp-mid    { background: #fff8e6; color: #e8a202; }
    .comp-high   { background: #fef0f0; color: #e74c3c; }
    .comp-none   { color: #ccc; }
  </style>
</head>
<body>
<div class="container">
  <h1>키워드 검색량 조회</h1>

  <div class="form-box">
    <form method="POST" action="/" id="search-form">
      <div class="form-row">
        <textarea name="keywords"
          placeholder="키워드를 한 줄에 하나씩 또는 콤마(,)로 구분해 입력&#10;예: 검색광고, 퍼포먼스마케팅, 네이버광고">{{ keywords_input }}</textarea>
        <div class="form-side">
          <button type="submit" class="btn-search" id="search-btn">조회</button>
          <div class="hint">네이버 + 구글<br>동시 조회</div>
        </div>
      </div>
    </form>
  </div>

  <div class="loading" id="loading">
    <span class="spinner"></span>
    네이버 · 구글 API 동시 조회 중... (10~20초 소요될 수 있습니다)
  </div>

  {% if error %}
  <div class="error">{{ error }}</div>
  {% endif %}

  {% if table_html %}
  <div class="result-box">
    <div class="result-header">
      <div class="result-meta">
        총 <b>{{ row_count }}</b>개 키워드
        <span class="badge badge-naver">네이버</span>
        <span class="badge badge-google">Google</span>
      </div>
      <form method="POST" action="/download">
        <input type="hidden" name="keywords" value="{{ keywords_input }}">
        <button type="submit" class="btn-dl">CSV 다운로드</button>
      </form>
    </div>
    <div class="table-wrap" id="table-area">
      {{ table_html | safe }}
    </div>
  </div>
  {% endif %}
</div>

<script>
  // 조회 버튼 클릭 시 로딩 표시
  document.getElementById('search-form').addEventListener('submit', function() {
    document.getElementById('search-btn').disabled = true;
    document.getElementById('search-btn').textContent = '조회 중...';
    document.getElementById('loading').style.display = 'block';
    const resultBox = document.querySelector('.result-box');
    if (resultBox) resultBox.style.opacity = '0.3';
  });

  // 테이블 후처리: 경쟁도 뱃지, 구글 0값 처리
  (function styleTable() {
    const table = document.querySelector('.result-table');
    if (!table) return;

    const headers = [...table.querySelectorAll('thead th')].map(th => th.textContent.trim());

    table.querySelectorAll('tbody tr').forEach(tr => {
      const cells = tr.querySelectorAll('td');
      cells.forEach((td, i) => {
        const header = headers[i] || '';
        const val = td.textContent.trim();

        // 경쟁도 셀 뱃지화
        if (header === '경쟁정도' || header === '구글 경쟁도') {
          if (val === '낮음') td.innerHTML = `<span class="comp comp-low">${val}</span>`;
          else if (val === '중간') td.innerHTML = `<span class="comp comp-mid">${val}</span>`;
          else if (val === '높음') td.innerHTML = `<span class="comp comp-high">${val}</span>`;
          else td.innerHTML = `<span class="comp comp-none">-</span>`;
        }

        // 구글 검색량 0이면 흐리게
        if (header === '구글 월간검색수' && (val === '0' || val === '')) {
          td.classList.add('dim');
        }

        // 숫자 천단위 콤마
        if (['PC 월간검색수','모바일 월간검색수','총 월간검색수','구글 월간검색수',
             'PC 월평균클릭수','모바일 월평균클릭수','월평균노출광고수'].includes(header)) {
          const n = parseInt(val.replace(/,/g, ''), 10);
          if (!isNaN(n)) td.textContent = n.toLocaleString();
        }
      });
    });

    // 헤더에 플랫폼 색상 적용
    table.querySelectorAll('thead th').forEach(th => {
      const t = th.textContent.trim();
      if (['PC 월간검색수','모바일 월간검색수','총 월간검색수','경쟁정도',
           'PC 월평균클릭수','모바일 월평균클릭수','PC 월평균클릭률(%)','모바일 월평균클릭률(%)','월평균노출광고수'].includes(t)) {
        th.classList.add('col-naver');
      }
      if (['구글 월간검색수','구글 경쟁도'].includes(t)) {
        th.classList.add('col-google');
      }
    });
  })();
</script>
</body>
</html>
